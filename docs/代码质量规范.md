# LDIMS MCP 服务代码质量规范

## 📋 概述

本文档定义了LDIMS MCP服务项目的代码质量标准和最佳实践。

## 🔧 工具配置

### ESLint 配置

项目使用ESLint进行代码质量检查，配置文件：`eslint.config.js`

#### 主要规则
- **TypeScript严格模式**: 启用严格类型检查
- **代码复杂度控制**: 函数复杂度不超过15
- **代码风格统一**: 使用双引号、分号结尾
- **安全性检查**: 禁用eval、new Function等不安全操作

#### 复杂度限制
- 函数复杂度: ≤ 15
- 嵌套深度: ≤ 4层
- 文件行数: ≤ 500行
- 函数行数: ≤ 100行
- 参数个数: ≤ 5个

### Prettier 配置

代码格式化配置文件：`.prettierrc.json`

#### 格式规则
- 缩进: 2个空格
- 引号: 双引号
- 分号: 必须
- 行宽: 80字符
- 尾随逗号: ES5兼容

## 📊 代码质量检查

### 自动化检查

```bash
# 完整质量检查
npm run quality

# 自动修复问题
npm run quality:fix

# 提交前检查
npm run pre-commit
```

### 检查项目

1. **ESLint检查**
   - 语法错误
   - 类型错误
   - 代码风格
   - 最佳实践

2. **Prettier格式检查**
   - 代码格式一致性
   - 缩进和空格
   - 换行和分号

3. **复杂度分析**
   - 函数复杂度
   - 文件大小
   - 嵌套层级
   - 代码重复

## 🎯 质量标准

### 代码质量等级

#### A级 (优秀)
- ESLint: 0 错误, 0 警告
- 格式化: 100% 符合规范
- 复杂度: 所有函数 ≤ 10

#### B级 (良好)
- ESLint: 0 错误, ≤ 5 警告
- 格式化: 100% 符合规范
- 复杂度: 所有函数 ≤ 15

#### C级 (及格)
- ESLint: 0 错误, ≤ 10 警告
- 格式化: ≥ 95% 符合规范
- 复杂度: ≤ 2个函数超过15

#### D级 (需要改进)
- 存在ESLint错误或不符合上述标准

### 文件组织规范

```
src/
├── config/          # 配置管理
├── types/           # 类型定义
├── tools/           # MCP工具实现
├── resources/       # MCP资源实现
├── handlers/        # 请求处理器
├── utils/           # 工具函数
├── errors/          # 错误处理
└── index.ts         # 入口文件
```

### 命名规范

#### 文件命名
- 使用kebab-case: `user-service.ts`
- 类型文件: `types.ts` 或 `user.types.ts`
- 测试文件: `user-service.test.ts`

#### 变量命名
- 变量/函数: camelCase
- 常量: UPPER_SNAKE_CASE
- 类/接口: PascalCase
- 私有成员: 前缀下划线

#### 函数命名
- 动词开头: `getUserById`, `validateInput`
- 布尔返回: `is`, `has`, `can` 前缀
- 异步函数: 明确表示异步性质

### 注释规范

#### JSDoc 注释
```typescript
/**
 * 获取用户信息
 * 
 * @param userId - 用户ID
 * @param includeProfile - 是否包含详细信息
 * @returns 用户信息对象
 * @throws {UserNotFoundError} 用户不存在时抛出
 */
async function getUserById(
  userId: string, 
  includeProfile = false
): Promise<User> {
  // 实现...
}
```

#### 行内注释
- 解释复杂逻辑
- 说明业务规则
- 标记TODO/FIXME

## 🚀 最佳实践

### TypeScript 使用

1. **严格类型检查**
   ```typescript
   // ✅ 好的做法
   interface User {
     id: string;
     name: string;
     email?: string;
   }
   
   // ❌ 避免使用 any
   const user: any = getData();
   ```

2. **类型守卫**
   ```typescript
   function isUser(obj: unknown): obj is User {
     return typeof obj === 'object' && 
            obj !== null && 
            'id' in obj;
   }
   ```

3. **泛型使用**
   ```typescript
   function createResponse<T>(data: T): ApiResponse<T> {
     return { success: true, data };
   }
   ```

### 错误处理

1. **统一错误类型**
   ```typescript
   class McpError extends Error {
     constructor(
       public code: string,
       message: string,
       public details?: unknown
     ) {
       super(message);
     }
   }
   ```

2. **错误边界**
   ```typescript
   try {
     await riskyOperation();
   } catch (error) {
     logger.error('Operation failed', { error });
     throw new McpError('OPERATION_FAILED', 'Failed to process request');
   }
   ```

### 异步编程

1. **Promise 使用**
   ```typescript
   // ✅ 使用 async/await
   async function fetchData(): Promise<Data> {
     const response = await api.get('/data');
     return response.data;
   }
   
   // ❌ 避免 Promise 链
   function fetchData(): Promise<Data> {
     return api.get('/data').then(response => response.data);
   }
   ```

2. **并发处理**
   ```typescript
   // 并行执行
   const [users, posts] = await Promise.all([
     fetchUsers(),
     fetchPosts()
   ]);
   ```

### 性能优化

1. **避免不必要的计算**
   ```typescript
   // ✅ 缓存计算结果
   const memoizedCalculation = useMemo(() => {
     return expensiveCalculation(data);
   }, [data]);
   ```

2. **合理使用解构**
   ```typescript
   // ✅ 只解构需要的属性
   const { id, name } = user;
   
   // ❌ 避免过度解构
   const { ...everything } = user;
   ```

## 📈 持续改进

### 代码审查清单

- [ ] 代码符合ESLint规则
- [ ] 代码格式符合Prettier规范
- [ ] 函数复杂度合理
- [ ] 类型定义完整
- [ ] 错误处理恰当
- [ ] 注释清晰有用
- [ ] 测试覆盖充分
- [ ] 性能考虑合理

### 质量监控

1. **定期检查**: 每次提交前运行质量检查
2. **趋势分析**: 跟踪代码质量指标变化
3. **团队培训**: 定期分享最佳实践
4. **工具更新**: 保持工具和规则的最新状态

## 🔗 相关资源

- [TypeScript 官方文档](https://www.typescriptlang.org/docs/)
- [ESLint 规则文档](https://eslint.org/docs/rules/)
- [Prettier 配置文档](https://prettier.io/docs/en/configuration.html)
- [Clean Code 原则](https://github.com/ryanmcdermott/clean-code-javascript)